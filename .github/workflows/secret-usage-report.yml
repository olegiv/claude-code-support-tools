name: Secret Usage Report

on:
  schedule:
    # Weekly report on Mondays at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      issues: write

    steps:
      - name: Generate Usage Report
        run: |
          echo "## Secret Usage Report"
          echo "Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""

          # Get workflow runs from past 7 days
          # Note: Using macOS-compatible date would need adjustment for Linux runners
          SINCE_DATE=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-7d +%Y-%m-%dT%H:%M:%SZ)

          echo "### Workflow Runs (Past 7 Days)"
          echo ""

          # Query Claude Code workflow runs
          CLAUDE_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${GH_REPO}/actions/workflows/claude.yml/runs?created=>=${SINCE_DATE}" \
            --jq '.workflow_runs | length' 2>/dev/null || echo "0")

          REVIEW_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${GH_REPO}/actions/workflows/claude-code-review.yml/runs?created=>=${SINCE_DATE}" \
            --jq '.workflow_runs | length' 2>/dev/null || echo "0")

          echo "- Claude Code (@claude mentions): ${CLAUDE_RUNS} runs"
          echo "- Claude Code Review (PR reviews): ${REVIEW_RUNS} runs"
          echo ""

          TOTAL_RUNS=$((CLAUDE_RUNS + REVIEW_RUNS))
          echo "**Total secret accesses**: ${TOTAL_RUNS}"
          echo ""

          # Alert on anomalies
          if [ "$TOTAL_RUNS" -gt 50 ]; then
            echo "::warning::Unusually high workflow activity: ${TOTAL_RUNS} runs in past 7 days"
            echo "⚠️ **Alert**: Unusually high activity detected (${TOTAL_RUNS} runs)"
          elif [ "$TOTAL_RUNS" -eq 0 ]; then
            echo "ℹ️ No Claude Code workflow runs in the past 7 days"
          else
            echo "✅ Activity within normal range"
          fi

          # List recent runs with actors
          echo ""
          echo "### Recent Runs Detail"
          echo ""
          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${GH_REPO}/actions/runs?per_page=10" \
            --jq '.workflow_runs[] | select(.name | test("Claude")) | "- \(.name) by \(.actor.login) at \(.created_at): \(.conclusion // "running")"' 2>/dev/null || echo "Unable to fetch run details"

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

      - name: Check for anomalies
        run: |
          # Additional anomaly detection
          SINCE_DATE=$(date -u -d '1 day ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-1d +%Y-%m-%dT%H:%M:%SZ)

          DAILY_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${GH_REPO}/actions/runs?created=>=${SINCE_DATE}" \
            --jq '[.workflow_runs[] | select(.name | test("Claude"))] | length' 2>/dev/null || echo "0")

          if [ "$DAILY_RUNS" -gt 20 ]; then
            echo "::error::Potential abuse detected: ${DAILY_RUNS} Claude workflow runs in past 24 hours"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
